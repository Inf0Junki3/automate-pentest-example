# Set up some variables. We'll specify non-confidential information in a config.yml file.
variable "config_file_path" {
  type = string
}

locals {
    configuration = yamldecode(file(var.config_file_path))
}

# These are confidential variables. You can set them up in GitHub secrets, Jenkins credentials, etc
variable "proxmox_url" {
  type = string
  sensitive = true
}

variable "proxmox_username" {
  type = string
  sensitive = true
}

variable "proxmox_password" {
  type = string
  sensitive = true
}

variable "proxmox_node" {
  type = string
  sensitive = true
}

variable "proxmox_base_image" {
  type = string
  sensitive = true
}

terraform {
    required_providers {
        proxmox = {
            source = "telmate/proxmox"
            version = "2.9.11"
        }
    }
}

provider "proxmox" {
  pm_api_url = var.proxmox_url
  pm_user = var.proxmox_username
  pm_password = var.proxmox_password
  pm_tls_insecure = local.configuration.terraform.proxmox_use_insecure
}

resource "proxmox_vm_qemu" "assessment_machine" {
    name = local.configuration.assessment_name
    target_node = var.proxmox_node
    clone = var.proxmox_base_image
    full_clone = true
    os_type = "cloud-init"

    cores = local.configuration.terraform.vm_cores
    memory = local.configuration.terraform.vm_memory
    agent = local.configuration.terraform.vm_install_guest_agent

    disk {
        size = local.configuration.terraform.vm_disk_size
        storage = "local-lvm"
        type = "scsi"
    }

    sshkeys = local.configuration.terraform.ssh_keys
}

resource "local_file" "ansible_inventory" {
    content = templatefile("inventory.tmpl", {
        machine_name = local.configuration.assessment_name
        machine_ip = proxmox_vm_qemu.assessment_machine.default_ipv4_address
        machine_user = local.configuration.terraform.vm_user
    })
    filename = "../ansible/inventory.yml"
}
